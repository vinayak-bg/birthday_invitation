rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to validate string length
    function validStringLength(str, min, max) {
      return str is string && str.size() >= min && str.size() <= max;
    }
    
    // Events collection
    match /events/{eventId} {
      // Owner can create their own events
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && validStringLength(request.resource.data.name, 1, 200)
        && validStringLength(request.resource.data.get('message', ''), 0, 1000);
      
      // Owner can read, update, and delete their own events
      allow read, update, delete: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      
      // Anyone can read event details (needed for guest RSVP page)
      allow read: if true;
    }
    
    // Invitations collection
    match /invitations/{invitationId} {
      // Owner can create invitations
      // Links are now generic (not tied to specific recipients)
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.eventId is string
        && request.resource.data.maxGuests is int
        && request.resource.data.maxGuests >= 1 
        && request.resource.data.maxGuests <= 50
        && request.resource.data.rsvps is list;
      
      // Owner can read, update, and delete their own invitations
      allow read, update, delete: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      
      // Anyone (including unauthenticated guests) can read invitations
      allow read: if true;
      
      // Anyone can update for RSVP submission (guests are not authenticated)
      // Validate the RSVP data being appended to rsvps array
      allow update: if 
        // Can only update these specific fields for RSVP
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['rsvpSubmitted', 'rsvps'])
        // Validate rsvps is an array
        && request.resource.data.rsvps is list
        // New RSVP added (array grew by 1)
        && request.resource.data.rsvps.size() == resource.data.rsvps.size() + 1
        // CRITICAL: Prevent overwritting/deleting existing RSVPs
        && request.resource.data.rsvps.hasAll(resource.data.rsvps)
        
        // Validate the new RSVP entry has required fields (numGuests is optional for backwards compatibility)
        && request.resource.data.rsvps[request.resource.data.rsvps.size() - 1].keys().hasAll(['familyName', 'attending', 'guestNames', 'additionalNotes', 'rsvpDate'])
        // Validate familyName length (1-100 chars)
        && validStringLength(request.resource.data.rsvps[request.resource.data.rsvps.size() - 1].familyName, 1, 100)
        // Validate attending is boolean
        && request.resource.data.rsvps[request.resource.data.rsvps.size() - 1].attending is bool
        
        // Validate numGuests if provided (optional)
        && (
          !request.resource.data.rsvps[request.resource.data.rsvps.size() - 1].keys().hasAny(['numGuests'])
          || (
            request.resource.data.rsvps[request.resource.data.rsvps.size() - 1].numGuests is int
            && request.resource.data.rsvps[request.resource.data.rsvps.size() - 1].numGuests >= 0
            && request.resource.data.rsvps[request.resource.data.rsvps.size() - 1].numGuests <= resource.data.maxGuests
          )
        )
        
        // Validate guestNames is an array
        && request.resource.data.rsvps[request.resource.data.rsvps.size() - 1].guestNames is list
        // Validate guestNames doesn't exceed maxGuests (hard limit)
        && request.resource.data.rsvps[request.resource.data.rsvps.size() - 1].guestNames.size() <= resource.data.maxGuests
        // Validate guestNames doesn't exceed numGuests if numGuests is provided
        && (
          !request.resource.data.rsvps[request.resource.data.rsvps.size() - 1].keys().hasAny(['numGuests'])
          || request.resource.data.rsvps[request.resource.data.rsvps.size() - 1].guestNames.size() <= request.resource.data.rsvps[request.resource.data.rsvps.size() - 1].numGuests
        )
        
        // Validate additionalNotes length (0-500 chars)
        && validStringLength(request.resource.data.rsvps[request.resource.data.rsvps.size() - 1].get('additionalNotes', ''), 0, 500)
        // Ensure rsvpSubmitted is boolean
        && request.resource.data.rsvpSubmitted is bool;
    }
  }
}
